<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>English Q&A Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Link CSS -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- TiÃªu Ä‘á» -->
  <header>
    <h1>ğŸ¤– English Q&A Practice</h1>
    <h2>ISC LONG XUYÃŠN</h2>
    <p>Báº¥m <strong>"MÃ¡y há»i cÃ¢u má»›i"</strong> Ä‘á»ƒ báº¯t Ä‘áº§u luyá»‡n táº­p.</p>
  </header>

  <!-- Khung Há»i-ÄÃ¡p -->
  <main>
    <div id="qaAssistant">
      <div id="qaChatBox"></div>
      <button id="qaAskBtn">ğŸ“˜ MÃ¡y há»i cÃ¢u má»›i</button>
      <button id="qaMicBtn">ğŸ¤ Tráº£ lá»i</button>
    </div>
  </main>

  <footer style="margin-top:20px; font-size:14px; color:#666;">
    <p>Thiáº¿t káº¿ cho Mobile â€¢ Há»— trá»£ Chrome / Edge</p>
  </footer>

  <script>
    const qaChatBox = document.getElementById("qaChatBox");
    const qaAskBtn = document.getElementById("qaAskBtn");
    const qaMicBtn = document.getElementById("qaMicBtn");

    let currentQuestion = "";
    let qaData = [];

    // Load dá»¯ liá»‡u tá»« file questions.json
    async function loadQuestions() {
      try {
        const res = await fetch("questions.json");
        qaData = await res.json();
        console.log("âœ… Loaded questions:", qaData);
      } catch (err) {
        console.error("âŒ Lá»—i khi load questions.json:", err);
        alert("KhÃ´ng táº£i Ä‘Æ°á»£c file questions.json");
      }
    }
    loadQuestions();

    // ThÃªm tin nháº¯n dáº¡ng bubble
    function addQAmessage(sender, text) {
      const div = document.createElement("div");
      if (sender === "MÃ¡y") {
        div.className = "message machine";
        div.innerHTML = `<strong>ğŸ¤– ${sender}:</strong> ${text}`;
      } else {
        div.className = "message user";
        div.innerHTML = `<strong>ğŸ™‹ ${sender}:</strong> ${text}`;
      }
      qaChatBox.appendChild(div);
      qaChatBox.scrollTop = qaChatBox.scrollHeight;
    }

    // MÃ¡y há»i cÃ¢u má»›i
    function askNewQuestion() {
      if (qaData.length === 0) {
        alert("âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u cÃ¢u há»i.");
        return;
      }
      const item = qaData[Math.floor(Math.random() * qaData.length)];
      currentQuestion = item.q;
      addQAmessage("MÃ¡y", currentQuestion);
      qaSpeakText(currentQuestion);
    }

    // NÃºt "MÃ¡y há»i cÃ¢u má»›i"
    qaAskBtn.addEventListener("click", () => {
      askNewQuestion();
    });

    // === Nháº­n diá»‡n giá»ng nÃ³i ===
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ nháº­n diá»‡n giá»ng nÃ³i. HÃ£y dÃ¹ng Chrome hoáº·c Edge má»›i nháº¥t.");
    }

    let qaRecognition;
    if (SpeechRecognition) {
      qaRecognition = new SpeechRecognition();
      qaRecognition.lang = "en-US";
      qaRecognition.interimResults = false;

      qaMicBtn.addEventListener("click", () => {
        if (!currentQuestion) {
          alert("ğŸ‘‰ HÃ£y Ä‘á»ƒ mÃ¡y há»i trÆ°á»›c rá»“i báº¡n má»›i tráº£ lá»i nhÃ©!");
          return;
        }
        qaRecognition.start();
      });

      qaRecognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.toLowerCase();
        addQAmessage("Báº¡n", transcript);

        const item = qaData.find(q => q.q === currentQuestion);
        let correct = false;

        if (item) {
          for (let ans of item.answers) {
            if (transcript.includes(ans.toLowerCase())) {
              correct = true;
              break;
            }
          }
        }

        if (correct) {
          addQAmessage("MÃ¡y", "âœ… OK, báº¡n vÆ°á»£t qua!");
          qaSpeakText("OK, you passed!");
        } else {
          addQAmessage("MÃ¡y", "âŒ Báº¡n Ä‘Ã£ tráº£ lá»i sai.");
          qaSpeakText("Sorry, your answer is incorrect.");
        }

        setTimeout(() => {
          askNewQuestion();
        }, 2000);
      };

      qaRecognition.onerror = (event) => {
        console.error("Lá»—i mic:", event.error);
        alert("âš ï¸ KhÃ´ng nháº­n Ä‘Æ°á»£c tÃ­n hiá»‡u tá»« micro. Vui lÃ²ng kiá»ƒm tra láº¡i quyá»n micro.");
      };
    }

    // Äá»c vÄƒn báº£n (mÃ¡y nÃ³i)
    function qaSpeakText(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "en-US"; 
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
