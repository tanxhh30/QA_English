<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>English Q&A Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Link CSS -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Tiêu đề -->
  <header>
    <h1>🤖 English Q&A Practice</h1>
    <h2>ISC LONG XUYÊN</h2>
    <p>Bấm <strong>"Máy hỏi câu mới"</strong> để bắt đầu luyện tập.</p>
  </header>

  <!-- Khung Hỏi-Đáp -->
  <main>
    <div id="qaAssistant">
      <div id="qaChatBox"></div>
      <button id="qaAskBtn">📘 Máy hỏi câu mới</button>
      <button id="qaMicBtn">🎤 Trả lời</button>
    </div>
  </main>

  <footer style="margin-top:20px; font-size:14px; color:#666;">
    <p>Thiết kế cho Mobile • Hỗ trợ Chrome / Edge</p>
  </footer>

  <script>
    const qaChatBox = document.getElementById("qaChatBox");
    const qaAskBtn = document.getElementById("qaAskBtn");
    const qaMicBtn = document.getElementById("qaMicBtn");

    let currentQuestion = "";
    let qaData = [];

    // Load dữ liệu từ file questions.json
    async function loadQuestions() {
      try {
        const res = await fetch("questions.json");
        qaData = await res.json();
        console.log("✅ Loaded questions:", qaData);
      } catch (err) {
        console.error("❌ Lỗi khi load questions.json:", err);
        alert("Không tải được file questions.json");
      }
    }
    loadQuestions();

    // Thêm tin nhắn dạng bubble
    function addQAmessage(sender, text) {
      const div = document.createElement("div");
      if (sender === "Máy") {
        div.className = "message machine";
        div.innerHTML = `<strong>🤖 ${sender}:</strong> ${text}`;
      } else {
        div.className = "message user";
        div.innerHTML = `<strong>🙋 ${sender}:</strong> ${text}`;
      }
      qaChatBox.appendChild(div);
      qaChatBox.scrollTop = qaChatBox.scrollHeight;
    }

    // Máy hỏi câu mới
    function askNewQuestion() {
      if (qaData.length === 0) {
        alert("⚠️ Chưa có dữ liệu câu hỏi.");
        return;
      }
      const item = qaData[Math.floor(Math.random() * qaData.length)];
      currentQuestion = item.q;
      addQAmessage("Máy", currentQuestion);
      qaSpeakText(currentQuestion);
    }

    // Nút "Máy hỏi câu mới"
    qaAskBtn.addEventListener("click", () => {
      askNewQuestion();
    });

    // === Nhận diện giọng nói ===
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("⚠️ Trình duyệt không hỗ trợ nhận diện giọng nói. Hãy dùng Chrome hoặc Edge mới nhất.");
    }

    let qaRecognition;
    if (SpeechRecognition) {
      qaRecognition = new SpeechRecognition();
      qaRecognition.lang = "en-US";
      qaRecognition.interimResults = false;

      qaMicBtn.addEventListener("click", () => {
        if (!currentQuestion) {
          alert("👉 Hãy để máy hỏi trước rồi bạn mới trả lời nhé!");
          return;
        }
        qaRecognition.start();
      });

      qaRecognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.toLowerCase();
        addQAmessage("Bạn", transcript);

        const item = qaData.find(q => q.q === currentQuestion);
        let correct = false;

        if (item) {
          for (let ans of item.answers) {
            if (transcript.includes(ans.toLowerCase())) {
              correct = true;
              break;
            }
          }
        }

        if (correct) {
          addQAmessage("Máy", "✅ OK, bạn vượt qua!");
          qaSpeakText("OK, you passed!");
        } else {
          addQAmessage("Máy", "❌ Bạn đã trả lời sai.");
          qaSpeakText("Sorry, your answer is incorrect.");
        }

        setTimeout(() => {
          askNewQuestion();
        }, 2000);
      };

      qaRecognition.onerror = (event) => {
        console.error("Lỗi mic:", event.error);
        alert("⚠️ Không nhận được tín hiệu từ micro. Vui lòng kiểm tra lại quyền micro.");
      };
    }

    // Đọc văn bản (máy nói)
    function qaSpeakText(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "en-US"; 
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
